<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Course Notes</title>
  <link rel="stylesheet" href="course-note.css" />
</head>
<body>
  <header>
    <div class="container">
      <h1>Course Notes</h1>
      <p class="subheading">I hope this helps you in your journey ðŸŒ±</p>
    </div>
  </header>

  <main class="container">
    <section class="courses">
      <h2>Available Courses</h2>

      <div class="search-container">
        <label for="search" class="visually-hidden">Search Courses</label>
        <input type="text" id="search" placeholder="Search Courses..." />

        <div class="category-filter">
          <label for="filterCategory">Filter by Category:</label>
          <select id="filterCategory">
            <option value="">All</option>
            <option value="CS">CS</option>
            <option value="NE">NE</option>
            <option value="IS">IS</option>
            <option value="CY">CY</option>
            <option value="CE">CE</option>
            <option value="ANOTHER">Another</option>
          </select>
        </div>
      </div>

      <div class="controls">
        <label for="itemType">Add new item:</label>
        <select id="itemType">
          <option value="">-- Choose type --</option>
          <option value="pdf">PDF</option>
          <option value="link">Link</option>
        </select>

        <button id="addButton" class="btn">Add</button>
      </div>

      <div id="formWrapper" class="form-wrapper">
        <h3>Add New Course Note</h3>
        <form id="noteForm" enctype="multipart/form-data">
          <input type="text" name="title" placeholder="Title" required>
          <textarea name="description" placeholder="Description" required></textarea>
          <input type="hidden" name="type" id="noteType" />

          <select name="category" required>
            <option value="" selected disabled>Choose a category</option>
            <option value="CS">CS</option>
            <option value="NE">NE</option>
            <option value="IS">IS</option>
            <option value="CY">CY</option>
            <option value="CE">CE</option>
            <option value="ANOTHER">Another</option>
          </select>

          <div id="pdf-upload" style="display: none;">
            <label>Upload PDF:</label>
            <input type="file" name="file_path_pdf" accept="application/pdf" />
          </div>

          <div id="link-input" style="display: none;">
            <label>Link URL:</label>
            <input type="url" name="file_path_link" placeholder="https://example.com" />
          </div>

          <div class="form-buttons">
            <button type="submit" class="btn">Submit</button>
            <button type="button" id="cancelButton" class="btn" style="background-color: #6c757d;">Cancel</button>
          </div>
        </form>
      </div>

      <div id="loading" style="text-align: center; display: none;">
        <p>Loading courses...</p>
      </div>
      
      <div id="course-grid" class="course-grid"></div>
      <div id="pagination" class="pagination"></div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p>Made by Noora Sami &copy; 2025</p>
    </div>
  </footer>

  <script>
  const API_BASE = "https://3f4a06db-f0b9-4d21-84e9-7b88bbacae3a-00-2kmk8spylbzqr.pike.replit.dev/course-notes-api.php";
  const API_ENDPOINTS = {
    PING: `${API_BASE}?action=ping`,
    GET_COURSES: `${API_BASE}?action=get-courses`,
    ADD_COURSE: `${API_BASE}?action=add-course`,
    VIEW_NOTE: (id) => `${API_BASE}?action=view-note&id=${id}`,
  };

  const courseGrid = document.getElementById("course-grid");
  const searchInput = document.getElementById("search");
  const categoryFilter = document.getElementById("filterCategory");
  const paginationDiv = document.getElementById("pagination");
  const noteTypeInput = document.getElementById("noteType");
  const noteForm = document.getElementById("noteForm");
  const formWrapper = document.getElementById("formWrapper");
  const addButton = document.getElementById("addButton");
  const cancelButton = document.getElementById("cancelButton");
  const loadingElement = document.getElementById("loading");

  let courses = [];
  let filteredCourses = [];
  let currentPage = 1;
  const itemsPerPage = 5;

  document.addEventListener("DOMContentLoaded", () => {
    setupEventListeners();
    checkServerConnection();
  });

  function setupEventListeners() {
    searchInput.addEventListener("input", () => {
      filterCourses(searchInput.value.toLowerCase(), categoryFilter.value);
    });

    categoryFilter.addEventListener("change", () => {
      filterCourses(searchInput.value.toLowerCase(), categoryFilter.value);
    });

    addButton.addEventListener("click", () => {
      const type = document.getElementById("itemType").value;
      if (!type) return alert("Please select a type first.");
      noteTypeInput.value = type;
      updateFormFields();
      formWrapper.style.display = "block";
    });

    cancelButton.addEventListener("click", () => {
      formWrapper.style.display = "none";
      noteForm.reset();
    });

    document.getElementById("itemType").addEventListener("change", updateFormFields);

    noteForm.addEventListener("submit", submitForm);
  }

  function updateFormFields() {
    const type = noteTypeInput.value || document.getElementById("itemType").value;
    const pdfField = document.getElementById("pdf-upload");
    const linkField = document.getElementById("link-input");

    pdfField.style.display = type === "pdf" ? "block" : "none";
    linkField.style.display = type === "link" ? "block" : "none";

    document.querySelector('input[name="file_path_pdf"]').required = type === "pdf";
    document.querySelector('input[name="file_path_link"]').required = type === "link";
  }

  function submitForm(e) {
    e.preventDefault();
    const formData = new FormData(noteForm);
    const submitButton = noteForm.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.textContent = "Submitting...";

    fetch(API_ENDPOINTS.ADD_COURSE, {
      method: "POST",
      body: formData,
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.status === "success") {
          alert("Note added successfully!");
          noteForm.reset();
          formWrapper.style.display = "none";
          fetchCourses();
        } else {
          throw new Error(data.message);
        }
      })
      .catch((err) => alert("Error: " + err.message))
      .finally(() => {
        submitButton.disabled = false;
        submitButton.textContent = "Submit";
      });
  }

  function checkServerConnection() {
    showLoading(true);
    fetch(API_ENDPOINTS.PING)
      .then((res) => res.json())
      .then((data) => {
        if (data.status === "success") fetchCourses();
        else throw new Error("Server responded but failed to validate.");
      })
      .catch((err) => {
        console.error("Server connection failed:", err.message);
        showLoading(false);
        useLocalData();
      });
  }

  function fetchCourses() {
    showLoading(true);
    fetch(API_ENDPOINTS.GET_COURSES)
      .then((res) => res.json())
      .then((data) => {
        showLoading(false);
        if (data.status !== "success") throw new Error(data.message);
        courses = data.data;
        filterCourses(searchInput.value.toLowerCase(), categoryFilter.value);
      })
      .catch((err) => {
        console.error("Fetch failed:", err.message);
        showLoading(false);
        courseGrid.innerHTML = `<p class='error'>Connection failed: ${err.message}</p>`;
        useLocalData();
      });
  }

  function filterCourses(search, category) {
    filteredCourses = courses.filter((c) => {
      const matchesSearch = !search || c.title.toLowerCase().includes(search) || c.description.toLowerCase().includes(search);
      const matchesCat = !category || c.category === category;
      return matchesSearch && matchesCat;
    });
    currentPage = 1;
    displayCourses();
    setupPagination();
  }

  function displayCourses() {
    courseGrid.innerHTML = "";
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const items = filteredCourses.slice(start, end);

    if (!items.length) {
      courseGrid.innerHTML = "<p class='error'>No courses found.</p>";
      return;
    }

    for (const course of items) {
      const div = document.createElement("div");
      div.className = "course-card";
      div.innerHTML = `
        <h3>${course.title}</h3>
        <p>${course.description.slice(0, 80)}${course.description.length > 80 ? "..." : ""}</p>
        <div class="course-meta">
          <span class="category-badge">${course.category}</span>
          <span class="type-badge">${course.file_type}</span>
        </div>
        <a href="#" class="btn view-note" data-id="${course.id}">View Notes</a>
      `;
      div.querySelector(".view-note").addEventListener("click", (e) => {
        e.preventDefault();
        viewCourseNote(course.id);
      });
      courseGrid.appendChild(div);
    }
  }

  function viewCourseNote(id) {
    fetch(API_ENDPOINTS.VIEW_NOTE(id))
      .then((res) => res.json())
      .then((data) => {
        if (data.status !== "success") throw new Error(data.message);
        const note = data.data;
        if (note.file_path) window.open(note.file_path, "_blank");
      })
      .catch((err) => alert("View error: " + err.message));
  }

  function setupPagination() {
    paginationDiv.innerHTML = "";
    const totalPages = Math.ceil(filteredCourses.length / itemsPerPage);
    if (totalPages <= 1) return;

    const addButton = (label, page) => {
      const btn = document.createElement("button");
      btn.innerHTML = label;
      if (page === currentPage) btn.classList.add("active");
      btn.addEventListener("click", () => {
        currentPage = page;
        displayCourses();
        setupPagination();
      });
      paginationDiv.appendChild(btn);
    };

    if (currentPage > 1) addButton("&laquo;", currentPage - 1);
    for (let i = 1; i <= totalPages; i++) addButton(i, i);
    if (currentPage < totalPages) addButton("&raquo;", currentPage + 1);
  }

  function showLoading(show) {
    loadingElement.style.display = show ? "block" : "none";
    if (show) {
      courseGrid.innerHTML = "";
      paginationDiv.innerHTML = "";
    }
  }

  function useLocalData() {
    const sample = [
      { id: 1, title: "Offline - Intro to HTML", description: "Learn the basics of HTML.", category: "CS", file_type: "link" },
      { id: 2, title: "Offline - Network Intro", description: "Understand basics of networks.", category: "NE", file_type: "link" },
    ];
    courses = sample;
    filterCourses(searchInput.value.toLowerCase(), categoryFilter.value);
  }

    // Initialize the application when DOM is loaded
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>